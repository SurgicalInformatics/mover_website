{
  "hash": "6b7fb3dab38f798d64a757a2d085da6a",
  "result": {
    "markdown": "---\ntitle: \"Baseline model preparation\"\nformat: html\neditor: visual\nexecute:\n  freeze: true\n---\n\n\n## Prepare baseline modeling data (including imputation)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(finalfit)\nlibrary(mice)\ntheme_set(theme_bw())\n\n#source(\"01_read_clean.R\")\n#source(\"../repos/mover_website/functions.R\")\nsource(\"functions.R\")\n```\n:::\n\n\nRead in the required data sets:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Patient informtion\npatient_information   = read_csv(\"/home/common/mover_data/surginf_cleaned/patient_information_cleaned.csv\")\n\n#Complications\ncomplications_cleaned = read_csv(\"/home/common/mover_data/surginf_cleaned/complications_cleaned.csv\")\n\n# LDA\npatient_lda = read_csv(\"/home/common/mover_data/srv/disk00/MOVER/EPIC/EMR/patient_lda.csv\") %>% \n  distinct %>% \n  janitor::clean_names()\n```\n:::\n\n\n# Introduction\n\nHere we prepare the data for developing a logistic regression model that serves as a baseline for predictions respiratory complications. The model will depend on basic data from the EPIC patient information data set. As a comparison we also include information from the patient LDA data set which details lines, drains, and airway devices used on the patient.\n\nHere we perform the following data preparation steps:\n\n-   Extract and wrangle LDA data\n\n-   Define sets of explanatory and dependent variables\n\n-   link complications, patient info and LDA data\n\n-   Impute with MICE\n\n## Wrangle LDA data\n\nThe EPIC LDA data set include information on lines, drains, and airway devices used on the patient, the time of placement, the time of removal, and location of placement. We extract the line_group_name variable:\n\n**Line_Group_Name:**\n\nLine_Group_Name groups the devices and events into 12 categories and provides a category name for the line, drain, airway device, or other event.\n\nAnd wrangle into a separate count for each category in each patient (each device/event can occur multiple times and locations, e.g. wrist, head etc.).\n\nMake a line group variable from patient LDA:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlda_grouped = patient_lda %>% \n  select(log_id, mrn, line_group_name) %>% \n  count(log_id, mrn, line_group_name) %>% \n  pivot_wider(names_from = line_group_name, values_from = n) %>% \n  dplyr::rename(\"missing\" = \"NA\") %>% \n  select(-missing) %>% \n  replace(is.na(.), 0)\n```\n:::\n\n\nTaking a glimpse:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlda_grouped %>% glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 61,798\nColumns: 17\n$ log_id                        <chr> \"00007e12602f85c5\", \"0001c7ea6b8a8c7a\", …\n$ mrn                           <chr> \"ed36a016e5bb2150\", \"d18eebe95e2c4292\", …\n$ `PIV Line`                    <int> 1, 1, 1, 4, 3, 2, 3, 1, 1, 1, 1, 3, 1, 2…\n$ Wound                         <int> 1, 1, 0, 2, 1, 4, 1, 1, 1, 0, 1, 4, 1, 2…\n$ `Urinary Drainage`            <int> 0, 1, 0, 2, 2, 1, 1, 0, 1, 0, 1, 0, 0, 0…\n$ `ART Line`                    <int> 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…\n$ Airway                        <int> 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…\n$ `CVC Line`                    <int> 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0…\n$ Drain                         <int> 0, 0, 0, 9, 2, 1, 1, 0, 1, 0, 1, 0, 0, 0…\n$ `Wound Therapy`               <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…\n$ `PICC Line`                   <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…\n$ `Pressure Ulcer Injury`       <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…\n$ `Line Type`                   <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…\n$ `Nasogastric/Orogastric tube` <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…\n$ Extravasation                 <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…\n$ `Epidural Line`               <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…\n$ `Intraosseous Line`           <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…\n```\n:::\n:::\n\n\n## Link complications, patient info and LDA\n\nImport and link complications with patient info. Not that we are using an inner join, which retains only (log_id, mrn) that are present in all the liked data sets.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlinked_data = inner_join(complications_cleaned, \n                         patient_information, \n                         by = join_by(log_id, mrn)) %>%\n  inner_join(lda_grouped, by = join_by(log_id, mrn)) %>%\n  distinct(log_id, mrn, .keep_all=T) %>% \n  \n  mutate(primary_anes_type_nm = case_when(\n    primary_anes_type_nm == \"Moderate Sedation - by non-anesthesia staff only\" ~ \"moderate_sedation\",\n    primary_anes_type_nm == \"Monitored Anesthesia Care (MAC)\" ~ \"monitored_anesthesia_care\",\n    primary_anes_type_nm == \"Choice Per Patient on Day of Surgery\" ~ \"patient_choice_on_day\",\n    TRUE ~ primary_anes_type_nm\n  )) %>% \n  janitor::clean_names()\n```\n:::\n\n\n## Define dependent and independent variables\n\nIn order to compare the the VITALS model of respiratory complications we select ***respiratory_comp*** as the dependent variable.\n\nThe basic set of independent variables are selected from the patient information data set as follows:\n\n-   ***birth_data***: age of the patient\n\n-   ***height_cm***: height in centimetres\n\n-   ***weight***\n\n-   ***sex***\n\n-   ***primary_anes_type_nm***: primary type of anesthesia a patient received.\n\n-   ***asa_rating_c***: ASA Physical Status Class 1-6 for each patient\n\n-   ***patient_class_group***: Inpatient or Outpatient\n\n-   ***icu_admin_flag***: whether or not a patient was admitted to the ICU during their visit. (if the complication is the reason for ICU admission then this is not an appropriate variable)\n\n-   A count of each category of lines/devices per patient.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndependent = \"respiratory_comp\"\nindependent = c(\n  \n  \"age\",\n  \"height_cm\",\n  \"weight\",\n  \"sex\",\n  \"primary_anes_type_nm\",\n  \"asa_rating_c\",\n  \"patient_class_group\",\n  \"icu_admin_flag\",\n  \n  \"piv_line\",\n  \"wound\",\n  \"urinary_drainage\",           \n  \"art_line\",\n  \"airway\",\n  \"cvc_line\",\n  \n  \"drain\",\n  \"wound_therapy\",\n  \"picc_line\",\n  \n  \"pressure_ulcer_injury\",\n  \"line_type\",\n  \"nasogastric_orogastric_tube\",\n  \n  \"extravasation\",\n  \"epidural_line\",\n  \"intraosseous_line\"\n)\n  \nimpute_data = linked_data %>% \n  select(dependent, all_of(independent)) %>% \n  drop_na(dependent)\n```\n:::\n\n\nSplit the data into train and test\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(2001)\nimpute_data$id = 1:nrow(impute_data)\nimpute_data_train <- impute_data %>% dplyr::sample_frac(0.80)\nimpute_data_test  <- dplyr::anti_join(impute_data, impute_data_train, by = 'id')\n\n#impute_data_train %>% write_rds(\"./results/train_set.rds\")\n#impute_data_test %>% write_rds(\"./results/test_set.rds\")\n\nimpute_data_train %>% write_rds(\"/home/common/mover_data/results/baseline_imputation/train_set.rds\")\nimpute_data_test %>% write_rds(\"/home/common/mover_data/results/baseline_imputation/test_set.rds\")\n```\n:::\n\n\n## Imputation\n\nImpute training data:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf = impute_data_train%>% \n  select(dependent, all_of(independent ))\n\ndf %>% \n  select(dependent, all_of(independent )) %>% \n  missing_predictorMatrix(\n    drop_from_imputed = c(dependent)#,\n#    drop_from_imputer = c(dependent)\n  ) -> predM_train\n\n# Run for 10 imputed sets with 10 iterations\n# Run in parallel over 5 cores. \nsets_train =  \n  mice(df, m = 10, predictorMatrix = predM_train, maxit = 10, \n           n.core = 2)#,  n.imp.core = 5)\n\n#sets_train %>% write_rds(\"./results/mice_train.rds\")\nsets_train %>% write_rds(\"/home/common/mover_data/results/baseline_imputation/mice_train.rds\")\n```\n:::\n\n\nImpute the test data:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf = impute_data_test%>% \n  select(dependent, all_of(independent ))\n\ndf %>% \n  select(dependent, all_of(independent )) %>% \n  missing_predictorMatrix(\n    drop_from_imputed = c(dependent),\n    drop_from_imputer = c(dependent)\n  ) -> predM_test\n\n# Run for 10 imputed sets with 10 iterations\n# Run in parallel over 5 cores. \nsets_test =  \n  mice(df, m = 10, predictorMatrix = predM_test, maxit = 10, \n           n.core = 2)#,  n.imp.core = 5)\n\n#sets_test %>% write_rds(\"./results/mice_test.rds\")\nsets_test %>% write_rds(\"/home/common/mover_data/results/baseline_imputation/mice_test.rds\")\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}